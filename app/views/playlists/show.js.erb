$(function () {
  // If true, the user is rearranging the playlist.
  var dragInProgress = false

  // Make the playlist sortable.
  $('.playlist').sortable({
    axis: 'y',
    cursor: 'n-resize',
    handle: '.handle',
    items: 'li',
    opacity: 0.9,
    start: startDrag,
    update: finishDrag
  })
  
  // Executed when a drag operation starts.
  function startDrag(event, ui) {
    dragInProgress = true
  }

  // Executed when a playlist drag operation has been finished.
  function finishDrag(event, ui) {
    $.ajax({
      type: 'PUT',
      url: '<%= playlist_path %>',
      data: $('.playlist').sortable('serialize'),
      complete: function() { dragInProgress = false }
    })
  }

  // Periodically update the playlist contents.
  (function periodic() {
    if(! dragInProgress) {
      $('.playlist').addClass('dragging-disabled').sortable('disable');
      
      $('.playlist').load('<%= playlist_path %>', function () {
        $('.playlist').removeClass('dragging-disabled').sortable('enable');
        setTimeout(periodic, 3000)
      })
    } else {
      setTimeout(periodic, 3000)
    }
  }())
})
