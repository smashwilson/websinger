$(function () {
  // If true, the user is rearranging the playlist.
  var dragInProgress = false

  // Make the playlist sortable.
  $('.playlist').sortable({
    axis: 'y',
    cursor: 'n-resize',
    handle: '.handle',
    items: 'li',
    opacity: 0.9,
    start: startDrag,
    update: finishDrag
  })
  
  // Executed when a drag operation starts.
  function startDrag(event, ui) {
    dragInProgress = true
  }

  // Executed when a playlist drag operation has been finished.
  function finishDrag(event, ui) {
    $.ajax({
      type: 'PUT',
      url: '<%= playlist_path %>',
      data: $('.playlist').sortable('serialize'),
      complete: function() { dragInProgress = false }
    })
  }
  
  // Bind "remove" link events on the list parent to avoid re-attaching event handlers every time the playlist is
  // refreshed.
  
  // Update the playlist after a delete operation completes (successfully or otherwise).
  $('.playlist').bind('ajax:complete', function(event, xhr) {
    reloadPlaylist()
  })
  
  // Asynchronously refresh the playlist, disabling drag-and-drop while doing so.
  function reloadPlaylist(andThen) {
    $('.playlist').addClass('dragging-disabled').sortable('disable')
    $('.playlist').load('<%= playlist_path %>', function () {
      $('.playlist').removeClass('dragging-disabled').sortable('enable')
      if(andThen) { andThen() }
    })
  }

  // Periodically update the playlist contents, unless something is in the midst of being drag-and-dropped.
  (function periodic() {
    if(! dragInProgress) {
      reloadPlaylist(function () { setTimeout(periodic, 3000) })
    } else {
      console.log('skipping reload')
      setTimeout(periodic, 3000)
    }
  }())
})
