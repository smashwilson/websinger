$(function () {
  // If true, the user is rearranging the playlist.
  var dragInProgress = false

  // Make the playlist sortable.
  $('.playlist').sortable({
    axis: 'y',
    cursor: 'n-resize',
    handle: '.handle',
    items: 'li',
    opacity: 0.9,
    start: startDrag,
    update: finishDrag
  })
  
  // Executed when a drag operation starts.
  function startDrag(event, ui) {
    dragInProgress = true
  }

  // Executed when a playlist drag operation has been finished.
  function finishDrag(event, ui) {
    $.ajax({
      type: 'PUT',
      url: '<%= playlist_path %>',
      data: $('.playlist').sortable('serialize'),
      complete: function() { dragInProgress = false }
    })
  }
  
  // Enable the Add button when a track is chosen from the autocomplete box.
  $('#track-name').bind( 'autocompleteselect', function() {
    $('#add-button').attr('disabled', false)
  })
  
  // When the Add button is clicked, submit an enqueue request with the id of the selected track.
  $('#add-button').click(function () {
    var trackId = $('#track-id').attr('value')
    var enqueuePath = '<%= enqueue_playlist_path(0) %>'.replace(/0/, trackId)
    
    $.ajax({
      type: 'POST',
      url: enqueuePath,
      complete: function() {
        $('#track-id').attr('value', null)
        $('#add-button').attr('disabled', true)
        $('#track-name').attr('value', '')
        reloadPlaylist()
      }
    })
    
    return false
  })
  
  // Bind "remove" link events on the list parent to avoid re-attaching event handlers every time the playlist is
  // refreshed.  Update the playlist after a delete operation completes (successfully or otherwise).
  $('.playlist').bind('ajax:complete', function(event, xhr) {
    reloadPlaylist()
  })
  
  // Asynchronously refresh the playlist, disabling drag-and-drop while doing so.
  function reloadPlaylist(andThen) {
    $('.playlist').addClass('dragging-disabled').sortable('disable')
    $('.playlist').load('<%= playlist_path %>', function () {
      $('.playlist').removeClass('dragging-disabled').sortable('enable')
      if(andThen) { andThen() }
    })
  }

  // Periodically update the playlist contents, unless something is in the midst of being drag-and-dropped.
  heartbeat(function () {
    if(! dragInProgress) { reloadPlaylist() }
  })
})
